<div class="w-100 min-h-screen bg-light">

    <div class="card border-0 shadow-sm form-card">

        <div class="card-header bg-white border-bottom px-4 py-3">
            <h5 class="mb-0 fw-semibold text-secondary">
                Edit Site
            </h5>
        </div>

        <div class="card-body px-4 py-4">
            @Html.AntiForgeryToken()


            <p class="text-muted mb-4">
                Update the site details below.
            </p>

            <!-- Hidden IDs -->
            <input type="hidden" id="SiteID">
            <input type="hidden" id="GrantID">

            <!-- Validation Summary -->
            <div id="validationSummary" class="alert alert-danger mb-4 d-none"></div>

            <!-- Site Name -->
            <div class="mb-4">
                <label class="form-label">Name</label>
                <input type="text" id="SiteName" class="form-control">
                <span class="text-danger" id="errName"></span>
            </div>

            <!-- Site Type -->
            <div class="mb-4">
                <label class="form-label">Site Type</label>
                <select id="SelectedTypeName" class="form-select">
                    <option value="">Select site type</option>
                </select>
                <span class="text-danger" id="errType"></span>
            </div>

            <!-- Address -->
            <div class="mb-4">
                <label class="form-label">Address</label>
                <input type="text" id="Address" class="form-control">
                <span class="text-danger" id="errAddress"></span>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-end gap-2 pt-3">
                <a id="btnCancel" class="btn btn-outline-secondary px-4">
                    Cancel
                </a>

                <button id="btnUpdate" class="btn btn-primary px-4">
                    Update
                </button>
            </div>

        </div>
    </div>
</div>


@section Scripts{
    <script>

        function loadSiteData(siteID) {
            $.ajax({
                url: '/Site/GetSiteByID',
                type: 'GET',
                data: { id: siteID },
                success: function (res) {
                    if (res.success) {
                        const site = res.data
                        //console.log("Site data loaded:", site)
                        //console.log("Selected Type: ", site.selectedType.TypeName)
                        $('#SiteID').val(site.SiteID)
                        $('#GrantID').val(site.GrantID)
                        $('#SiteName').val(site.SiteName)
                        $('#Address').val(site.Address)

                        let dropdowList = $("#SelectedTypeName");
                        dropdowList.append(`<option value="">Select site type</option>`);

                        $.each(site.siteTypes, function (ind, type) {
                            dropdowList.append(`<option value="${type.TypeName}">${type.TypeName}</option>`);
                        })

                        dropdowList.val(
                            site.siteTypes.find(t => t.EntityTypeID == site.selectedType.EntityTypeID)?.TypeName
                        )

                    } else {
                        alert('Error loading site data: ' + res.message)
                    }
                },
                error: function (err) {
                    alert('AJAX error loading site data.')
                }
            })
        }

        function handleValidationErrors(errors) {
            // Clear previous errors
            $('#validationSummary').addClass('d-none').empty();
            $('#errName').text('');
            $('#errType').text('');
            $('#errAddress').text('');
            let summary = $('#validationSummary');
            let hasSummaryErrors = false;
            errors.forEach(err => {
                if (err.field === 'Name') {
                    $('#errName').text(err.message);
                } else if (err.field === 'Type') {
                    $('#errType').text(err.message);
                } else if (err.field === 'Address') {
                    $('#errAddress').text(err.message);
                } else {
                    hasSummaryErrors = true;
                    summary.append(`<div>${err.message}</div>`);
                }
            });
            if (hasSummaryErrors) {
                summary.removeClass('d-none');
            }
        }

        function handleEditSubmit() {

            handleValidationErrors([]);

            const siteData = {
                SiteID: $('#SiteID').val(),
                GrantID: $('#GrantID').val(),
                SiteName: $('#SiteName').val(),
                SelectedTypeName: $('#SelectedTypeName').val(),
                Address: $('#Address').val()
            }

            var tokenInput = $('input[name="__RequestVerificationToken"]');
            if (tokenInput.length) {
                siteData.__RequestVerificationToken = tokenInput.val();
            } else {
                console.warn('Anti-forgery token input not found on page.');
            }

            $.ajax({
                url: "/Site/Edit",
                type: "POST",
                data: siteData,
                success: function (res) {
                    if (res.success) {
                        var GranteeID = localStorage.getItem('GranteeID')
                        window.location.href = `/Grantee/Index/${GranteeID}`;
                    } else if (res.validationErrors) {
                        handleValidationErrors(res.validationErrors);
                    } else {
                        alert('Error updating site: ' + res.message);
                    }
                },
            })
        }

        $(document).ready(function () {
            const siteID = new URLSearchParams(window.location.search).get("SiteID")
            console.log("Editing site with ID:", siteID)
            loadSiteData(siteID)

            $("#btnUpdate").on("click", handleEditSubmit);
        })
    </script>
}